- hosts: localhost
  connection: local
  gather_facts: no
  roles:
    - role: ansible-network.network-engine

  tasks:
    - name: "find platforms"
      find:
        paths: "parser_templates/"
        recurse: no
        file_type: directory
        excludes: 'meta,tests'
      register: platforms

    - name: "find cli asserts"
      find:
        paths: "{{ item }}/cli/assert/"
        recurse: yes
        file_type: file
        patterns: "*"
      loop: "{{ platforms.files | map(attribute='path') | list }}"
      register: cli_asserts

    - name: "find cli facts"
      find:
        paths: "{{ item }}/cli/fact/"
        recurse: yes
        file_type: file
        patterns: "*"
      loop: "{{ platforms.files | map(attribute='path') | list }}"
      register: cli_facts

    - name: "find cli inputs"
      find:
        paths: "{{ item }}/cli/input/"
        recurse: yes
        file_type: file
        patterns: "*"
      loop: "{{ platforms.files | map(attribute='path') | list }}"
      register: cli_inputs

    - name: "test cli parsers"
      command_parser:
        file: "{{ item.0 }}"
        content: "{{ lookup('file', item.1 ) }}"
      with_together:
        - "{{ cli_facts | json_query('results[*].files[*].path') | list }}"
        - "{{ cli_inputs | json_query('results[*].files[*].path') | list }}"

    - name: "assert cli parsers"
      include_tasks: "{{ item }}"
      with_items: "{{ cli_asserts | json_query('results[*].files[*].path') | list }}"
